apiVersion: v1
kind: Pod
metadata:
  name: {{POD_NAME}}
spec:
  volumes:
    - name: home-vol
      emptyDir:
        sizeLimit: 10Gi
    - name: persistent-vol
      persistentVolumeClaim:
        claimName: {{PVC_CLAIM_NAME}}
    - name: ssh-key
      secret:
        secretName: ssh-key-{{USER}}
  securityContext:
    # Keep fsGroup to ensure PVC files are accessible at /$USER
    # Run as root to allow package installation
    fsGroup: 1001
  containers:
    - name: interactive-ssh
      image: rocm/dev-ubuntu-24.04:latest
      imagePullPolicy: IfNotPresent
      command:
        - /bin/bash
        - -c
        - |
          set -eux
          export DEBIAN_FRONTEND=noninteractive
          ESSENTIAL_PACKAGES="sudo openssh-server curl git"

          install_packages() {
            apt-get install -y --no-install-recommends $ESSENTIAL_PACKAGES
          }

          if ! install_packages >/tmp/apt-install.log 2>&1; then
            echo "Initial package install failed, refreshing apt cache (this may take a while)..."
            cat /tmp/apt-install.log || true
            rm -f /tmp/apt-install.log
            apt-get update -qq
            install_packages
          fi
          rm -f /tmp/apt-install.log || true

          # Create ossci user with uid 1001 (matching fsGroup) with bash as default shell
          useradd -u 1001 -m -s /bin/bash ossci || true

          # Give ossci user sudo privileges
          echo 'ossci ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/ossci
          chmod 0440 /etc/sudoers.d/ossci

          # Setup SSH access (fsGroup: 1001 handles PVC ownership)
          # Fix home directory permissions (SSH requires home not be world-writable)
          chmod 755 /home/ossci
          chown ossci:ossci /home/ossci

          mkdir -p /home/ossci/.ssh
          cp /mnt/sshkey/authorized_keys /home/ossci/.ssh/authorized_keys
          chmod 700 /home/ossci/.ssh
          chmod 600 /home/ossci/.ssh/authorized_keys
          chown -R ossci:ossci /home/ossci/.ssh

          # Start SSH daemon
          mkdir -p /var/run/sshd
          /usr/sbin/sshd -D
      volumeMounts:
        - name: home-vol
          mountPath: /home/ossci
          readOnly: false
        - name: persistent-vol
          mountPath: /{{USER}}
          readOnly: false
        - name: ssh-key
          mountPath: /mnt/sshkey
          readOnly: true
      resources:
        # Number of gpus available in the interactive vscode session.
        limits:
          amd.com/gpu: 1
